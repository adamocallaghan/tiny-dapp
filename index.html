<!DOCTYPE html>

<html>
    <head>
        <title>Tiny Dapp</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Arimo&family=Prata&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="styles.css">
        <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    </head>
    <body>
        <div id="main">
            <h1 id="title">Tiny Dapp</h1>
            <div>
                <button class="button" onclick="connectMetamask()" id="connect">Connect Metamask</button>
                <h2>Your Metamask wallet is connected with account: <span id="walletAddress"></span></h2> 
                <h2>And you are connected to: <span id="blockchain"></span></h2>
            </div>
            <div>
                <button class="button" onclick="connectContract()" id="connect">Connect to Smart Contract</button>
                <h2><span id="contract"></span></h2>
            </div>
            <div>
                <button class="button" onclick="readContract()" id="connect">Read from Smart Contract <i>(Should be '0' as not initialised)</i></button>
                <h2>Number in Contract is: <span id="contractValue"></span></h2>
            </div>
        </div>
    </body>
    <script>
        // Connect Metamask - Get Account Address + ChainID
        let account;
        const connectMetamask = async() => {
            console.log("connectMetamask clicked!");
            if (window.ethereum !== undefined) {
                console.log(window.ethereum);
                const accounts = await ethereum.request({method: "eth_requestAccounts"});
                const chainId = await ethereum.request({ method: 'eth_chainId' });
                account = accounts[0];
                console.log(account);
                document.getElementById("walletAddress").innerHTML = account;
                if(chainId == "0x1") {
                    document.getElementById("blockchain").innerHTML = "Ethereum";
                }
            } else if(window.ethereum == undefined) {
                let noMetamask = "Metamask is not installed";
                console.log(noMetamask);
                document.getElementById("walletAddress").innerHTML = noMetamask;
            }
        }

        // Connect to Smart Contract using Web3.js
        const connectContract = async () => {
            const ABI = [
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "num",
                        "type": "uint256"
                    }
                ],
                "name": "store",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "retrieve",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ]; // ABI
            const Address = "0xa55bEf93d997A3eE0f96cAC40C6D7b5a6f94f855"; // Contract Address
            window.web3 = await new Web3(window.ethereum);
            console.log(window.web3);
            window.contract = await new window.web3.eth.Contract(ABI, Address);
            console.log(window.contract);
            document.getElementById("contract").innerHTML = "Connected to Smart Contract";
        }

        // Read the number from the Smart Contract
        const readContract = async () => {
            const data = await window.contract.methods.retrieve().call();
            document.getElementById("contractValue").innerHTML = data;
        }

    </script>
</html>